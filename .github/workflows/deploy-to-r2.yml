name: Deploy to Cloudflare R2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS CLI for R2
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws-region: auto
      
      - name: Sync to R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          # Install AWS CLI
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install
          
          # Sync all files to R2
          aws s3 sync . s3://$R2_BUCKET \
            --endpoint-url $R2_ENDPOINT \
            --exclude ".git/*" \
            --exclude "*.py" \
            --exclude "*.md" \
            --exclude ".gitignore" \
            --exclude ".github/*" \
            --delete
          
          echo "‚úÖ Deployment to R2 completed successfully!"
      
      - name: Comment on PR with deployment info
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        env:
          R2_DEV_URL: ${{ secrets.R2_DEV_URL }}
          CUSTOM_DOMAIN_URL: ${{ secrets.CUSTOM_DOMAIN_URL }}
        with:
          script: |
            // Get the commit that triggered this workflow
            const commit = context.sha;
            
            // Find PRs that were merged with this commit
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commit
            });
            
            // Filter for merged PRs
            const mergedPRs = prs.filter(pr => pr.merged_at !== null);
            
            if (mergedPRs.length === 0) {
              console.log('No merged PR found for this commit');
              return;
            }
            
            // Get the most recent merged PR
            const pr = mergedPRs[0];
            
            // Get workflow run URL
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // Get URLs from environment variables
            const r2DevUrl = process.env.R2_DEV_URL || 'Not configured';
            const customDomainUrl = process.env.CUSTOM_DOMAIN_URL || 'Not configured';
            
            // Create comment body
            const commentBody = `## üöÄ Deployment Status
            
            ‚úÖ **Successfully deployed to Cloudflare R2**
            
            ### Deployment Information
            
            - **Workflow Run**: [View Pipeline](${runUrl})
            - **Commit**: ${commit.substring(0, 7)}
            - **Triggered by**: ${context.actor}
            - **Timestamp**: ${new Date().toISOString()}
            
            ### Access URLs
            
            - **üåê Production URL**: ${customDomainUrl}
            - **üîß Development URL**: ${r2DevUrl}
            
            ### Next Steps
            
            The website has been automatically synced to R2. Changes should be visible within a few minutes.
            
            ---
            *This comment was automatically generated by GitHub Actions*`;
            
            // Post comment to PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: commentBody
            });
            
            console.log(`Posted deployment info to PR #${pr.number}`);
